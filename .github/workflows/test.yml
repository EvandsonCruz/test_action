name: Validar Presença da Palavra "alter" no Meio da Linha do Conteúdo do PR

on:
  pull_request:
    types:
      - opened
      - synchronize
    paths-ignore:
      - '.github/workflows/**'

jobs:
  validar-conteudo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v2
        with:
         fetch-depth: 0

      - name: Configurar variável de ambiente GH_TOKEN
        run: echo "GH_TOKEN=${{ secrets.GH_TOKEN }}" >> $GITHUB_ENV   

      - name: Verificar Conteúdo do PR
        run: |
          palavras_chave=("alter table" "drop package")  # Substitua pela lista de palavras-chave desejada
          outras_palavras=("ab.teste")  # Substitua pela segunda lista de palavras 

          echo "encontrada=false" >> $GITHUB_ENV
          echo "saida=" >> $GITHUB_ENV

          for arquivo in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }}); do
            for palavra_chave in "${palavras_chave[@]}"; do
              if grep -q "$palavra_chave" "$arquivo"; then
                echo "Encontrada a palavra '$palavra_chave' no arquivo: $arquivo"
                # Verificar também se alguma palavra da segunda lista está presente no mesmo arquivo
                for outra_palavra in "${outras_palavras[@]}"; do
                  if grep -q "$outra_palavra" "$arquivo"; then
                    echo "Encontrada a palavra '$outra_palavra' no mesmo arquivo: $arquivo"
                    echo "encontrada=true" #>> $GITHUB_ENV
                    #echo "encontrada=$encontrada" >> $GITHUB_ENV
                    saida="$saida$palavra_chave no objeto $outra_palavra no arquivo $arquivo\n" >> $GITHUB_ENV
                    saida="$saida" >> $GITHUB_ENV
                    echo "**************************************** $saida"
                    #echo "output=$output" >> $GITHUB_ENV
                  fi
                  done
                 fi
            done
          done
          echo "!!!!!!!!!!!!!!!!!!!!!!!! '$encontrada'"
          echo "!!!!!!!!!!!!!!!!!!!!!!!! '$saida'"
          if [ true == true ]; then
            SLACK_MESSAGE="Label 'bug' adicionada ao PR: ${{ github.event.number }} - github.com/${GITHUB_REPOSITORY}/pull/${{ github.event.number }}\n$saida"
            curl -X POST -H 'Content-type: application/json' --data '{"text":"'"$SLACK_MESSAGE"'"}' ${{ secrets.SLACK_WEBHOOK_URL }}
           exit 0
          fi
          
      - name: Add label
        run: |
          echo "!!!!!!!!!!!!!!!!!!!!!!!! '$saida'"
          if [ "$encontrada" == true ]; then
            echo "::warning::Uma ou mais palavras-chave foram encontradas nos arquivos. Adicionando a label 'bug'..."
            gh pr edit ${{ github.event.number }} --add-label bug
            exit 0
          fi

      - name: Notificar slack
        run: |
          if [ "$encontrada" == true ]; then
            SLACK_MESSAGE="Label 'bug' adicionada ao PR: ${{ github.event.number }} - ${GITHUB_REPOSITORY}/pull/${{ github.event.number }}\n$saida"
            curl -X POST -H 'Content-type: application/json' --data '{"text":"'"$SLACK_MESSAGE"'"}' ${{ secrets.SLACK_WEBHOOK_URL }}
           exit 0
          fi
