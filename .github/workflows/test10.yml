name: Caracteres especiais
on:
  push:
    branches:
      - main

jobs:
  validar-caracteres:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Configurar variável de ambiente GH_TOKEN
        run: echo "GH_TOKEN=${{ secrets.GH_TOKEN }}" >> $GITHUB_ENV

      - name: Obter lista de arquivos alterados
        run: |
          set -x
          branch=$(echo "${{ github.ref }}" | awk -F'/' '{print $NF}')
          # Obter a lista de arquivos alterados no push
          arquivos_alterados=($(git diff --name-only HEAD^1))

          # Adicionar ação para validar encoding
          for arquivo in "${arquivos_alterados[@]}"; do
            encoding_info=$(file -i "$arquivo" | awk -F "=" '{print $2}' | tr -d ' ')
            
            if [ "$encoding_info" != "us-ascii" ] && [ "$encoding_info" != "utf-8" ] && [ "$encoding_info" != "binary" ]; then
              echo ">>>>>>>>>>>>>>>> $encoding_info"
              echo "::error::Existe arquivo com caracteres especiais no push"
              saida+="$arquivo"$'\n'
              encontrado=true
            fi
          done
          
          if [ "$encontrado" == true ]; then
            echo "Arquivo(s) com caracteres especiais encontrados. Commit bloqueado."
            
            # Enviar notificação para o Slack
            SLACK_MESSAGE="Existe arquivo com caracteres especiais no push
            github.com/${GITHUB_REPOSITORY} ($branch)"
            curl -X POST -H 'Content-type: application/json' --data '{"text":"'"$SLACK_MESSAGE"'"}' ${{ secrets.SLACK_WEBHOOK_URL }}
            
            exit 1
          fi
