name: identifier too long

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited
    paths-ignore:
      - '.github/workflows/**'

jobs:
  validar-trecho:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do repositório
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Obter conteúdo do pull request
      id: obter-conteudo
      run: |
        if [[ "${{ github.event.action }}" == "opened" || "${{ github.event.action }}" == "reopened" ]]; then
          conteudo_pr=($(git diff --name-only HEAD^1))
          echo "########################### $conteudo_pr"
        else
          conteudo_pr=($(git diff --name-only ${{ github.event.before }} ${{ github.sha }}))
          echo "########################### $conteudo_pr"
        fi

    - name: Verificar identificador
      run: |
        tem_erro=false
        saida=""

        #echo "########################### ${{ conteudo_pr }}"

        if echo "$conteudo_pr" | grep -q -i -E '\.\S{31}'; then
          echo "Encontrado um identificador com mais de 30 caracteres"
          SLACK_MESSAGE="Encontrado um identificador com mais de 30 caracteres no PR: ${{ github.event.number }} - github.com/${GITHUB_REPOSITORY}/pull/${{ github.event.number }}/files (${{ github.base_ref }})\n$saida"
          curl -X POST -H 'Content-type: application/json' --data '{"text":"'"$SLACK_MESSAGE"'"}' ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_NUMBER=$(echo "${{ github.event.pull_request.html_url }}" | awk -F'/' '{print $NF}')
          REPO_OWNER=$(echo "${{ github.repository }}" | cut -d '/' -f 1)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d '/' -f 2)
          AUTHOR_NAME=${{ github.event.pull_request.user.login }}
          gh pr comment $PR_NUMBER -R $REPO_OWNER/$REPO_NAME --body "@$AUTHOR_NAME por favor revisar"
          exit 1
        else
          echo "Não Encontrado um identificador com mais de 30 caracteres."
          exit 0
        fi
